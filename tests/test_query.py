import httpretty

from tests import FulcrumTestCase


class QueryTest(FulcrumTestCase):
    @httpretty.activate
    def test_query_csv(self):
        httpretty.register_uri(httpretty.POST, self.api_root + '/query',
            body='_record_id,_project_id,_assigned_to_id,_status,_latitude,_longitude,_created_at,_updated_at,_version,_created_by_id,_updated_by_id,_server_created_at,_server_updated_at,_geometry,_altitude,_speed,_course,_horizontal_accuracy,_vertical_accuracy,_changeset_id,_title,_created_latitude,_created_longitude,_created_geometry,_created_altitude,_created_horizontal_accuracy,_updated_latitude,_updated_longitude,_updated_geometry,_updated_altitude,_updated_horizontal_accuracy,_created_duration,_updated_duration,_edited_duration,name,date,amount,receipt_photos,receipt_photos_captions\n897e1c76-1698-4626-a55e-9e64af6cb22f,ee322adc-64a8-493e-b670-e6d821224896,,processed,27.7710877052,-82.6370750987,2016-10-27 11:54:51 UTC,2016-10-31 13:33:58 UTC,3,4f1efa091441405373000445,4f1efa091441405373000445,2016-10-27 11:56:54 UTC,2017-04-10 10:39:27 UTC,SRID=4326;POINT(-82.6370750987057 27.7710877052111),8.70811843872,-1,-1,65,10,d2330139-2589-4e95-844c-dde6cec81ea0,"Thursday Breakfast , 2016-10-27",27.7710877052,-82.6370750987,SRID=4326;POINT(-82.6370750987057 27.7710877052111),8.70811843872,65,27.7712809621,-82.6372989547,SRID=4326;POINT(-82.6372989547277 27.7712809620684),8.61361122131,10,27,6,33,Thursday Breakfast ,2016-10-27,9.84,67e109fb-b1f5-4e3f-ad88-059d10dc8d9c,\n',
            status=200)
        sql = 'SELECT * FROM stuff LIMIT 1;'
        content = self.fulcrum_api.query(sql, 'csv')
        self.assertIsInstance(content, bytes)

    @httpretty.activate
    def test_query_default(self):
        httpretty.register_uri(httpretty.POST, self.api_root + '/query',
            body='{"fields": [{"name": "_record_id", "type": "string"}, {"name": "_project_id", "type": "string"}, {"name": "_assigned_to_id", "type": "string"}, {"name": "_status", "type": "string"}, {"name": "_latitude", "type": "double"}, {"name": "_longitude", "type": "double"}, {"name": "_created_at", "type": "timestamp"}, {"name": "_updated_at", "type": "timestamp"}, {"name": "_version", "type": "integer"}, {"name": "_created_by_id", "type": "string"}, {"name": "_updated_by_id", "type": "string"}, {"name": "_server_created_at", "type": "timestamp"}, {"name": "_server_updated_at", "type": "timestamp"}, {"name": "_geometry", "type": "geometry"}, {"name": "_altitude", "type": "double"}, {"name": "_speed", "type": "double"}, {"name": "_course", "type": "double"}, {"name": "_horizontal_accuracy", "type": "double"}, {"name": "_vertical_accuracy", "type": "double"}, {"name": "_changeset_id", "type": "string"}, {"name": "_title", "type": "string"}, {"name": "_created_latitude", "type": "double"}, {"name": "_created_longitude", "type": "double"}, {"name": "_created_geometry", "type": "geometry"}, {"name": "_created_altitude", "type": "double"}, {"name": "_created_horizontal_accuracy", "type": "double"}, {"name": "_updated_latitude", "type": "double"}, {"name": "_updated_longitude", "type": "double"}, {"name": "_updated_geometry", "type": "geometry"}, {"name": "_updated_altitude", "type": "double"}, {"name": "_updated_horizontal_accuracy", "type": "double"}, {"name": "_created_duration", "type": "integer"}, {"name": "_updated_duration", "type": "integer"}, {"name": "_edited_duration", "type": "integer"}, {"name": "name", "type": "string"}, {"name": "date", "type": "date"}, {"name": "amount", "type": "double"}, {"name": "receipt_photos", "type": "string[]"}, {"name": "receipt_photos_captions", "type": "string[]"}], "rows": [{"_record_id": "897e1c76-1698-4626-a55e-9e64af6cb22f", "_project_id": "ee322adc-64a8-493e-b670-e6d821224896", "_assigned_to_id": null, "_status": "processed", "_latitude": 27.7710877052, "_longitude": -82.6370750987, "_created_at": "2016-10-27T11:54:51.000Z", "_updated_at": "2016-10-31T13:33:58.000Z", "_version": 3, "_created_by_id": "4f1efa091441405373000445", "_updated_by_id": "4f1efa091441405373000445", "_server_created_at": "2016-10-27T11:56:54.293Z", "_server_updated_at": "2017-04-10T10:39:27.349Z", "_geometry": {"type": "Point", "coordinates": [-82.6370750987057, 27.7710877052111]}, "_altitude": 8.70811843872, "_speed": -1, "_course": -1, "_horizontal_accuracy": 65, "_vertical_accuracy": 10, "_changeset_id": "d2330139-2589-4e95-844c-dde6cec81ea0", "_title": "Thursday Breakfast , 2016-10-27", "_created_latitude": 27.7710877052, "_created_longitude": -82.6370750987, "_created_geometry": {"type": "Point", "coordinates": [-82.6370750987057, 27.7710877052111]}, "_created_altitude": 8.70811843872, "_created_horizontal_accuracy": 65, "_updated_latitude": 27.7712809621, "_updated_longitude": -82.6372989547, "_updated_geometry": {"type": "Point", "coordinates": [-82.6372989547277, 27.7712809620684]}, "_updated_altitude": 8.61361122131, "_updated_horizontal_accuracy": 10, "_created_duration": 27, "_updated_duration": 6, "_edited_duration": 33, "name": "Thursday Breakfast ", "date": "2016-10-27T00:00:00.000Z", "amount": 9.84, "receipt_photos": ["67e109fb-b1f5-4e3f-ad88-059d10dc8d9c"], "receipt_photos_captions": [null]}], "time": 0.01, "date": 1539895212724}',
            status=200)
        sql = 'SELECT * FROM stuff LIMIT 1;'
        content = self.fulcrum_api.query(sql)
        self.assertIsInstance(content, dict)
        self.assertEqual(content['date'], 1539895212724)

    @httpretty.activate
    def test_query_geojson(self):
        httpretty.register_uri(httpretty.POST, self.api_root + '/query',
            body='{"type": "FeatureCollection", "features": [{"type": "Feature", "properties": {"_record_id": "897e1c76-1698-4626-a55e-9e64af6cb22f", "_project_id": "ee322adc-64a8-493e-b670-e6d821224896", "_assigned_to_id": null, "_status": "processed", "_latitude": 27.7710877052, "_longitude": -82.6370750987, "_created_at": "2016-10-27T11:54:51.000Z", "_updated_at": "2016-10-31T13:33:58.000Z", "_version": 3, "_created_by_id": "4f1efa091441405373000445", "_updated_by_id": "4f1efa091441405373000445", "_server_created_at": "2016-10-27T11:56:54.293Z", "_server_updated_at": "2017-04-10T10:39:27.349Z", "_altitude": 8.70811843872, "_speed": -1, "_course": -1, "_horizontal_accuracy": 65, "_vertical_accuracy": 10, "_changeset_id": "d2330139-2589-4e95-844c-dde6cec81ea0", "_title": "Thursday Breakfast , 2016-10-27", "_created_latitude": 27.7710877052, "_created_longitude": -82.6370750987, "_created_geometry": {"srid": 4326, "hasZ": false, "hasM": false, "x": -82.6370750987057, "y": 27.7710877052111}, "_created_altitude": 8.70811843872, "_created_horizontal_accuracy": 65, "_updated_latitude": 27.7712809621, "_updated_longitude": -82.6372989547, "_updated_geometry": {"srid": 4326, "hasZ": false, "hasM": false, "x": -82.6372989547277, "y": 27.7712809620684}, "_updated_altitude": 8.61361122131, "_updated_horizontal_accuracy": 10, "_created_duration": 27, "_updated_duration": 6, "_edited_duration": 33, "name": "Thursday Breakfast ", "date": "2016-10-27T00:00:00.000Z", "amount": 9.84, "receipt_photos": ["67e109fb-b1f5-4e3f-ad88-059d10dc8d9c"], "receipt_photos_captions": [null]}, "geometry": {"type": "Point", "coordinates": [-82.6370750987057, 27.7710877052111]}}]}',
            status=200)
        sql = 'SELECT * FROM stuff LIMIT 1;'
        content = self.fulcrum_api.query(sql, 'geojson')
        self.assertIsInstance(content, dict)
        self.assertEqual(content['type'], 'FeatureCollection')
